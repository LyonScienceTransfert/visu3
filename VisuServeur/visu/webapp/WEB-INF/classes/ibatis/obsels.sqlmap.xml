<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="obsels">

	<typeAlias alias="obsel" type="com.ithaca.domain.model.Obsel" />

	<cacheModel id="cache" type="LRU" readOnly="false">
        <flushInterval hours="24"/>
        <flushOnExecute statement="obsels.delete"/>
        <flushOnExecute statement="obsels.insert"/>
        <flushOnExecute statement="obsels.update"/>
        <property name="cache-size" value="1000"/>
    </cacheModel>

	<resultMap class="obsel" id="obselResult">
		<result column="id" jdbcType="INTEGER" property="id" />
		<result column="trace" jdbcType="VARCHAR" property="trace" />
		<result column="type" jdbcType="VARCHAR" property="type" />
		<result column="begin" javaType="java.util.Date" property="begin" />
		<result column="rdf" jdbcType="LONGVARCHAR" property="rdf" />
	</resultMap>

	<sql id="selectBase">
		SELECT id, trace, type, begin, rdf
	</sql>

	
	<select id="getObsel" parameterClass="int" resultMap="obselResult" cacheModel="cache">
		<include refid="selectBase" />
		FROM obsels WHERE id = #value#
	</select>
		
	<select id="getTraces" cacheModel="cache">
	    SELECT DISTINCT trace
		FROM obsels
        ORDER BY trace
	</select>

	<select id="getTrace" parameterClass="String" resultMap="obselResult" cacheModel="cache">
		<include refid="selectBase" />
		FROM obsels
		WHERE trace = #value#
	</select>

	<select id="getSessionStartObselsForUserId" parameterClass="String" resultMap="obselResult" cacheModel="cache">
		<include refid="selectBase" />
		FROM obsels
		WHERE type = 'SessionStart' and trace like #value#
	</select>

	<select id="getTextCommentsObselsForStartObsel" parameterClass="String" resultMap="obselResult" cacheModel="cache">
		<include refid="selectBase" />
		FROM obsels
		WHERE type = 'TextComment' and rdf like #value#
	</select>
	
	<insert id="insert" parameterClass="obsel">
		INSERT INTO obsels
		SET 
		    trace = #trace#,
			type = #type#,
			begin = #begin#,
			rdf = #rdf#

		<selectKey keyProperty="id" resultClass="java.lang.Integer">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>

	<update id="update" parameterClass="obsel">
		UPDATE obsels
		SET 
		    trace = #trace#,
			type = #type#,
			begin = #begin#,
			rdf = #rdf#
		where id = #id:INTEGER#
	</update>

	<delete id="delete" parameterClass="obsel">
		DELETE from obsels WHERE id = #id:INTEGER#
	</delete>

</sqlMap>
