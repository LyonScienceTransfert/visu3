<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="users">

	<typeAlias alias="user" type="com.lyon2.visu.domain.model.User" />
    
    <typeAlias alias="sessionUser" type="com.lyon2.visu.domain.model.SessionUser" />
    
    <cacheModel id="cache" type="LRU" readOnly="false">
        <flushInterval hours="24"/>
       	<flushOnExecute statement="users.delete"/>
        <flushOnExecute statement="users.insert"/>
        <flushOnExecute statement="users.update"/>
        <property name="cache-size" value="1000"/>
    </cacheModel>

	<resultMap class="user" id="userResult">
		<result column="u_id" jdbcType="BIGINT" property="id_user" />
		<result column="lastname" jdbcType="VARCHAR"
			property="lastname" />
		<result column="firstname" jdbcType="VARCHAR"
			property="firstname" />
		<result column="mail" jdbcType="VARCHAR" property="mail" />
		<result column="profil" jdbcType="VARCHAR" property="profil" />     
		<result column="activation_key" jdbcType="VARCHAR" property="activation_key" />
		<result column="avatar" jdbcType="VARCHAR" property="avatar" />
		<result column="message" jdbcType="VARCHAR" property="message" />	
	</resultMap>

	<sql id="selectBase">
		select id_user as u_id, lastname, firstname, mail, profil, avatar, activation_key, message
	</sql>
	
	<select id="getUsers" parameterClass="user"
		resultMap="userResult" cacheModel="cache">
		<include refid="selectBase" />
		FROM users 
        ORDER BY profil, id_user, firstname, lastname
	</select>

	<select id="getUser" parameterClass="int"
		resultMap="userResult" cacheModel="cache">
		<include refid="selectBase" />
		FROM users 
        WHERE id_user = #value#
	</select>

	<select id="getUserByActivatedKey" parameterClass="String"
		resultMap="userResult" cacheModel="cache">
		<include refid="selectBase" />
		FROM users 
        WHERE activation_key = #value#
	</select>

	<select id="getUserByUsernamePassword" parameterClass="java.util.HashMap"
		resultMap="userResult"  cacheModel="cache">
    	<include refid="selectBase" />
        FROM 
            users
        WHERE
        	
        	mail = #username#
        AND 
      		password = #password#	
    </select>
    
    <select id="getUsersFromSession" parameterClass="int"
		resultMap="userResult" cacheModel="cache">
		SELECT u.id_user as u_id, lastname, firstname, mail, profil, avatar, activation_key, message
        FROM users u , session_users s
        WHERE s.id_session = #value# AND s.id_user = u.id_user
    </select>
    
	<insert id="insert" parameterClass="user">
		INSERT INTO users 
		SET 
			lastname = #lastname:VARCHAR#, 
			firstname = #firstname:VARCHAR#, 
			mail = #mail:VARCHAR#, 
			profil = #profil:LONGVARBINARY#,
		 	activation_key = #activation_key:VARCHAR#,
		 	avatar = #avatar:VARCHAR#,
		 	message = #message:VARCHAR#
		<selectKey keyProperty="id_user" resultClass="java.lang.Integer">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	<update id="update" parameterClass="user">
		<!--
			WARNING - This element is automatically generated by Abator for iBATIS, do not modify.
			This element was generated on Tue May 26 16:38:12 CEST 2009.
		-->
		UPDATE 
			users
		SET 
			lastname = #lastname:VARCHAR#, 
			firstname = #firstname:VARCHAR#, 
			mail = #mail:VARCHAR#, 
			profil = #profil:BIGINT#,
			activation_key = #activation_key:VARCHAR#,
			avatar = #avatar:VARCHAR#,
			message = #message:VARCHAR#
		WHERE id_user = #id_user:BIGINT#
	</update>
	
	<update id="updatePassword">
		UPDATE 
			users
		SET 
			password = #password#
		WHERE id_user = #userId#
	</update>
	
	<update id="setUserPassword">
		UPDATE 
			users
		SET 
			password = #password#,
			activation_key = null
		WHERE id_user = #userId#
	</update>

	<delete id="delete"
		parameterClass="user">		 
		DELETE FROM users WHERE id_user = #id_user:BIGINT#
	</delete>
	
	
	
</sqlMap>