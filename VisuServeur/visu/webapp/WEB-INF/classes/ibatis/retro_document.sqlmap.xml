<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="rd">
	
	<typeAlias alias="retroDocument" type="com.ithaca.domain.model.RetroDocument"/>	
	
	<resultMap class="retroDocument" id="retroDocument-result-map-without-xml">
		<result column="id_retro_document" property="documentId"  />
        <result column="id_owner" property="ownerId"  />
        <result column="id_session" property="sessionId"  />
        <result column="creation_date" property="creationDate"  />
        <result column="last_modification_date" property="lastModified"  />
		<result column="title" property="title" />
		<result column="description" property="description" />
	</resultMap>
	
	<resultMap class="retroDocument" id="retroDocument-result-map">
		<result column="id_retro_document" property="documentId"  />
        <result column="id_owner" property="ownerId"  />
        <result column="id_session" property="sessionId"  />
        <result column="creation_date" property="creationDate"  />
        <result column="last_modification_date" property="lastModified"  />
		<result column="title" property="title" />
		<result column="description" property="description" />
		<result column="xml" property="xml" />
	</resultMap>

	<select id="getDocuments" resultMap="retroDocument-result-map">
		SELECT * FROM retro_document
	</select>
	
	<select id="getDocumentsByOwnerIdAndSessionIdWithoutXML" resultMap="retroDocument-result-map-without-xml">
		SELECT id_retro_document, id_owner, id_session, creation_date, last_modification_date, title, description
		FROM retro_document 
		WHERE id_owner=#ownerId# AND id_session=#sessionId#
	</select>

	<select id="getDocumentById" resultMap="retroDocument-result-map">
		SELECT * FROM retro_document WHERE id_retro_document=#value#
	</select>

	<select id="countDocuments" resultClass="java.lang.Integer">
		SELECT count(*) FROM retro_document
	</select>

	<select id="getDocumentsByOwnerIdAndSessionId" resultMap="retroDocument-result-map">
		SELECT * FROM retro_document WHERE id_owner=#ownerId# AND id_session=#sessionId#
	</select>

	<select id="getDocumentsByOwner" resultMap="retroDocument-result-map">
		SELECT * FROM retro_document WHERE id_owner=#value#
	</select>
	
	<select id="getInviteesByDocumentId" resultClass="java.lang.Integer">
		SELECT id_user FROM retro_document_access WHERE id_retro_document=#value#
	</select>

	<select id="getDocumentsByInviteeId" resultClass="java.lang.Integer">
		SELECT id_retro_document 
		FROM retro_document_access 
		WHERE id_user=#value#
	</select>

	<select id="getDocumentsByInviteeIdAndSessionIdWithoutXML" resultMap="retroDocument-result-map-without-xml">
	SELECT rd.id_retro_document, rd.id_owner, rd.id_session, rd.creation_date, rd.last_modification_date, rd.title, rd.description
	FROM retro_document_access as rda, retro_document as rd
	WHERE rda.id_user=#inviteeId# and rd.id_session=#sessionId# and rda.id_retro_document = rd.id_retro_document
	</select>
	
	<delete id="deleteDocument">
		DELETE from retro_document WHERE id_retro_document = #value#
	</delete>
	
	<delete id="deleteAllInvitations">
		DELETE from retro_document_access WHERE id_retro_document = #value#
	</delete>

	<delete id="deleteInvitation">
		DELETE from retro_document_access 
		WHERE id_retro_document = #documentId:INTEGER#
		AND id_user = #userId:INTEGER#
	</delete>

	<insert id="insertInvitation">
		INSERT INTO retro_document_access 
		SET id_retro_document=#documentId:INTEGER#,
			id_user=#userId:INTEGER#
	</insert>
		
	<insert id="insertDocument" parameterClass="retroDocument">
		INSERT INTO retro_document
		SET 
		    id_owner = #ownerId#,
		    id_session = #sessionId#,
		    creation_date = now(),
		    last_modification_date = now(),
		    title = #title#,
		    description = #description#,
		    xml = #xml#

		<selectKey keyProperty="documentId" resultClass="java.lang.Integer">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
	<update id="updateDocument" parameterClass="retroDocument">
		UPDATE retro_document
			SET 
		    id_owner = #ownerId#,
		    id_session = #sessionId#,
		    last_modification_date = now(),
		    title = #title#,
		    description = #description#,
		    xml = #xml#
		where id_retro_document = #documentId:INTEGER#
	</update>
	
</sqlMap>
