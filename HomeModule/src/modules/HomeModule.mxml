<?xml version="1.0" encoding="utf-8"?>
<modules:VisuModuleBase xmlns:fx="http://ns.adobe.com/mxml/2009"
	xmlns:s="library://ns.adobe.com/flex/spark" xmlns:mx="library://ns.adobe.com/flex/mx"
	xmlns:modules="com.ithaca.visu.modules.*" xmlns:maps="maps.*"
	xmlns:mate="http://mate.asfusion.com/" xmlns:controls="com.ithaca.visu.controls.*"
	configure="configureHandler(event)" creationComplete="creationCompleteHandler(event)"
	top="15" bottom="5" left="5" right="5" height="100%">
	<fx:Declarations>


		<maps:HomeMap id="homeMap" dispatcher="{this}" />
		<mate:Listener type="{SessionEvent.UPDATE_LIST_SESSION}"
			method="updateSessionView" />
		<mate:Listener type="{SessionEvent.UPDATE_LIST_USER}"
			method="updateView" />
		<mate:Listener type="{ApplicationMenuEvent.UPDATE_LANGUAGE}"
			method="updateLanguageNavigateurDay" />
		<mate:Listener type="{SessionEvent.SHOW_LIST_DATE_SESSION}"
			method="showDateSession" />
		<mate:Listener type="{SessionEvent.SHOW_LIST_SESSION}"
			method="showSession" />
			
		<mate:Listener type="{SessionEvent.LOAD_LIST_USERS_PLATEFORME}"
			method="onLoadedAllUsers" />
	
		<mx:ArrayCollection id="usersList" filterFunction="keepUser"/>
	</fx:Declarations>


	
	<fx:Script>
		<![CDATA[
			import com.ithaca.visu.controls.SessionHomeElement;
			import com.ithaca.visu.controls.globalNavigation.event.ApplicationMenuEvent;
			import com.ithaca.visu.events.InitMapEvent;
			import com.ithaca.visu.events.MessageEvent;
			import com.ithaca.visu.events.SessionEvent;
			import com.ithaca.visu.events.SessionHomeElementEvent;
			import com.ithaca.visu.events.SessionUserEvent;
			import com.ithaca.visu.events.UserEvent;
			import com.ithaca.visu.events.VisuModuleEvent;
			import com.ithaca.visu.model.Model;
			import com.ithaca.visu.model.Session;
			import com.ithaca.visu.model.User;
			import com.ithaca.visu.model.vo.SessionUserVO;
			import com.ithaca.visu.model.vo.UserVO;
			import com.ithaca.visu.renderer.FluxActivityRenderer;
			import com.ithaca.visu.ui.utils.ConnectionStatus;
			import com.ithaca.visu.ui.utils.RoleEnum;
			import com.ithaca.visu.ui.utils.RightStatus;
			import com.ithaca.visu.view.user.MessageUser;
			import com.ithaca.utils.VisuUtils;
			
			import gnu.as3.gettext.FxGettext;
			import gnu.as3.gettext._FxGettext;
			
			import mx.collections.ArrayCollection;
			import mx.collections.Sort;
			import mx.collections.SortField;
			import mx.events.CollectionEvent;
			import mx.events.FlexEvent;
			
			import spark.events.IndexChangeEvent;
			
			
			[Bindable]
			private var fxgt:_FxGettext;
			
			[Bindable]
			public var listSessionView:ArrayCollection;
			

			[Bindable]
			public var listDateForNavigateurDay:ArrayCollection;
			
			[Bindable]
			public var fluxActivity : ArrayCollection;
			
			private var _editableSession:Boolean;
			private var _loggedUser:User;

			protected function configureHandler(event:VisuModuleEvent):void
			{				
				// init map of this  module
				var initMapEvent:InitMapEvent = new InitMapEvent(InitMapEvent.INIT_MAP_HOME);
				this.dispatchEvent(initMapEvent);
			}
			
			protected function creationCompleteHandler(event:FlexEvent):void
			{
				fxgt = FxGettext;
				
				// check if this is first enter in HomeModule
				var homeModule:VisuModuleBase = Model.getInstance().getCurrentHomeModule();
				if(homeModule == null)
				{
					// add mesage Welcome
					var namePlateforme:String = Model.getInstance().getNamePlateforme();
					var user:User = Model.getInstance().getLoggedUser();
					Model.getInstance().addFluxActivity(user.id_user,user.firstname,user.avatar,fxgt.gettext("Bienvenue sur ")+namePlateforme,new Date());		
					// add flux activity
					Model.getInstance().addFluxActivity(user.id_user,user.firstname,user.avatar,fxgt.gettext(" a rejoint ")+namePlateforme+".",new Date());
					var listConnectedUser:ArrayCollection = Model.getInstance().getConnectedUserExcludeLoggedUser();
					var strConnectedUser:String = ""
					var nbrUser:int = listConnectedUser.length;
					for(var nUser:int = 0 ; nUser < nbrUser; nUser++)
					{
						var virgulePoint:String=', ';
						var userConnected:User = listConnectedUser.getItemAt(nUser) as User;
						if(nUser == nbrUser-1)
						{
							virgulePoint = '.'	
						}
						strConnectedUser += userConnected.firstname+virgulePoint;
					}
					if(strConnectedUser != "")
					{
						var namePlateforme:String = Model.getInstance().getNamePlateforme();
						// add message about connected users
						Model.getInstance().addFluxActivity(user.id_user,user.firstname,user.avatar,fxgt.gettext("Actuellement connecté à ")+namePlateforme+" : "+strConnectedUser,new Date());
					}
				}
				
				Model.getInstance().setCurrentHomeModule(this);
				
				_loggedUser = Model.getInstance().getLoggedUser();				
				// check status logged user
				var statusLoggedUser:int =_loggedUser.status; 
				if(statusLoggedUser == ConnectionStatus.CONNECTED)
				{
					Model.getInstance().updateStatusLoggedUser(ConnectionStatus.PENDING);
					var outSession:SessionEvent = new SessionEvent(SessionEvent.OUT_SESSION);
					outSession.userId = _loggedUser.id_user;
					this.dispatchEvent(outSession);
				}
				
				var profile:String = _loggedUser.profil;				
				_editableSession = RightStatus.hasRight(profile, RightStatus.CAN_MODIFY_OTHER_SESSION);
				// image of the logged user
				//imageLoggedUser.source = _loggedUser.avatar;
				// promt in navigateurDay
				navigateurDay.prompt = fxgt.gettext("Veuillez sélectionner une date de séance");				
				// remove all views the session
				this.listSessionView = new ArrayCollection();
				this.sessionGroup.removeAllElements();
				
				var vb:VGroup = new VGroup();	
				this.sessionGroup.addElement(vb);
				
				if(Model.getInstance().hasDateSession())
				{
					// set dataProvider the navigateurDay  
					this.listDateForNavigateurDay = Model.getInstance().getSessionDate();
					// get last time selected item navigateurDay
					var lastSelectedObject:Object = Model.getInstance().getSelectedItemNavigateurDayByLoggedUser();
					var sessionEvent:SessionEvent = new SessionEvent(SessionEvent.UPDATE_LIST_SESSION);
					sessionEvent.listSession = lastSelectedObject.listSessionDate;
					sessionEvent.sessionDate = lastSelectedObject.labelDate;
					dispatchEvent(sessionEvent);				
				}else{
					// id loggedUser
					var loggedUserId:int = Model.getInstance().getLoggedUser().id_user;
					// getiing list date of sessions from BD
					var sessionEvent:SessionEvent = new SessionEvent(SessionEvent.LOAD_LIST_DATE_SESSION);
					sessionEvent.userId = loggedUserId;				
					dispatchEvent(sessionEvent);					
				}
			}
			
			/**
			 * Send message to all users
			 */ 
			protected function sendAll_clickHandler():void
			{						
				var event:MessageEvent = new MessageEvent(MessageEvent.SEND_PUB_MESSAGE);
				event.senderUserId = Model.getInstance().getLoggedUser().getId();
				event.message = this.textToSend.text.toString();
				dispatchEvent(event);
				this.textToSend.text = ""; 
				var loggerUser:User = Model.getInstance().getLoggedUser();
	/* 			listConUsers.visible = false; 
 */			}
			
			/**
			 * Send message to one user
			 */ 
			protected function sendMessageToUser():void
			{
/* 				var userId:int = this.listConUsers.selectedItem.id_user;
				var text:String = this.textToSend.text.toString();
				var event:MessageEvent = new MessageEvent(MessageEvent.SEND_PRV_MESSAGE);
				event.senderUserId = Model.getInstance().getLoggedUser().getId();
				event.message = text;
				event.resiverUserId = userId;
				dispatchEvent(event);
				this.textToSend.text = "";  
				var loggerUser:User = Model.getInstance().getLoggedUser();
				Model.getInstance().addFluxActivity(loggerUser.id_user,loggerUser.firstname, loggerUser.avatar,"[private] "+text ,new Date());
				listConUsers.visible = false; */
			}
			
			/**
			 * Update session view
			 */ 
			public function updateSessionView(event:SessionEvent):void
			{
				var homeModule:HomeModule = Model.getInstance().getCurrentHomeModule() as HomeModule
				if( homeModule == this)
				{
					this.listDateForNavigateurDay = Model.getInstance().getSessionDate();
					// set selected label date 
					var openDate:Object = Model.getInstance().getSelectedItemNavigateurDayByLoggedUser();
					this.navigateurDay.selectedItem = openDate;
					// update view only if date of session for updating the same with date on navigateurDay
					if(openDate.labelDate == event.sessionDate)
					{					
						var listSession:ArrayCollection = event.listSession;
						this.listSessionView = new ArrayCollection();
						this.sessionGroup.removeAllElements();
						var vb:VGroup = new VGroup();	
						vb.percentWidth = 100;
						var listConnectedUser:ArrayCollection = Model.getInstance().getConnectedUsers();
						var listSwapUsers:ArrayCollection = Model.getInstance().getSwapUsers(); 
						if(listSession != null)
						{
							var nbrSession:uint = listSession.length;
							if(nbrSession == 0)
							{
								var labelMessage:Label = new Label();
								labelMessage.setStyle("fontSize", 14);
								labelMessage.setStyle("fontWeight", "bold");
								labelMessage.text = fxgt.gettext("  \n\n\n Vous n'avez pas de séance pour cette date...\n\n\n");
								vb.addElement(labelMessage);
							}else
							{
								for(var nSession:uint = 0; nSession < nbrSession; nSession++)
								{
									var session:Session = listSession[nSession];
									var sessionView:SessionHomeElement = new SessionHomeElement();
									sessionView.percentWidth = 100;
/* 									sessionView.width = navigateurDay.width - navigateurDay.rightButton.width; */
									// check connected users
									session.checkConnectedUsers(listConnectedUser);
									sessionView.session = session;
									sessionView.editable = _editableSession;
									sessionView.swapItems = listSwapUsers;
									sessionView.loggedUser = _loggedUser;
									// listener for change user in the session 
									sessionView.addEventListener(SessionHomeElementEvent.CHANGE_SESSION_USER, onChangeSessionUsers);
									// listener for action the logged user
									sessionView.addEventListener(SessionHomeElementEvent.CLICK_ACTION_LOGGED_USER, onClickActionLoggedUser);
									vb.addElement(sessionView);
									this.listSessionView.addItem(sessionView);	
								}
							} 	
						}else
							{	
							// havn't session to show by this date 
							navigateurDay.selectedIndex = -1;
						}
							// add updated vb groupe
							this.sessionGroup.addElement(vb);
					}
				}
			}	
			
			private function showDateSession(event :SessionEvent):void{
				if( Model.getInstance().getSessionDate().length == 0)
				{
					Model.getInstance().setSessionDate(event.listDate);
					this.listDateForNavigateurDay = Model.getInstance().getSessionDate();
					var elementDateStartToday:Object = getObjectDateSessionStartToday(this.listDateForNavigateurDay);
					var labelDate:String = elementDateStartToday.labelDate;
					Model.getInstance().setSelectedItemNavigateurDayByLoggedUser(elementDateStartToday);
					
					var sessionEventLoad:SessionEvent = new SessionEvent(SessionEvent.LOAD_LIST_SESSION);
					sessionEventLoad.userId = Model.getInstance().getLoggedUser().id_user;
					sessionEventLoad.sessionDate = labelDate;
					dispatchEvent(sessionEventLoad);
				}
			}
			
			private function showSession(event :SessionEvent):void{
				if(Model.getInstance().getCurrentHomeModule() as HomeModule == this){
					// FIXME have to change name the property 
					var listSession :Array = event.listDate;
					Model.getInstance().setListSessionsByDate(listSession , event.sessionDate);
					
					var nbrSession:uint = listSession.length;
					if(nbrSession != 0)
					{
						for(var nSession:uint = 0; nSession < nbrSession ; nSession++)
						{
							var userEvent:UserEvent = new UserEvent(UserEvent.LOAD_LIST_USERS_SESSION);
							userEvent.sessionId = listSession[nSession].id_session;
							userEvent.sessionDate = event.sessionDate;
							dispatchEvent(userEvent);			
						}	
					}else
					{
						var sessionEvent:SessionEvent = new SessionEvent(SessionEvent.UPDATE_LIST_SESSION);
						var listSessionEmpty:ArrayCollection = new ArrayCollection();
						sessionEvent.listSession = listSessionEmpty;
						sessionEvent.sessionDate = event.sessionDate;
						dispatchEvent(sessionEvent);	
					}
				}				
			}

			/**
			 * 
			 */
			private function getObjectDateSessionStartToday(arr:ArrayCollection):Object
			{
				var date:Date = new Date();
				var result:Object = null;
				var deltaPositive:Number = Number.MAX_VALUE;
				var deltaNegative:Number = Number.MAX_VALUE;
				var hasDateToday:Boolean = false;
				var nbrElement:uint = arr.length;
				for(var nElement:uint = 0; nElement < nbrElement ; nElement++)
				{
					var elmDate:Date = arr[nElement].fullDate;
					if(isDateToday(elmDate)){
						result = arr[nElement];
						hasDateToday = true;
						break;
					}
				
					var tempDelta:Number = elmDate.getTime() - date.getTime();
					if(tempDelta > 0)
					{
						if(tempDelta < deltaPositive)
						{
							deltaPositive = tempDelta;
							result = arr[nElement];
						}
					}else{
						tempDelta = tempDelta * -1;
						if(tempDelta < deltaNegative)
						{
							deltaNegative = tempDelta;
							result = arr[nElement];
						}
					}
				}	
				
				if(!hasDateToday)
				{
					// where will add date today
					var obj:Object = null;
					var index:uint = arr.getItemIndex(result);
					var diff:Number = (result.fullDate as Date).getTime() - date.getTime();
					if(diff < 0)
					{
						 index++;
					}
					obj = Model.getInstance().addSessionDateToday(index);
					return obj;
					
				}else return result; 
			}	
			
			private function isDateToday(arrDate:Date):Boolean
			{
				var date:Date = new Date();
				if(date.getFullYear() == arrDate.getFullYear())
				{
					if(date.getMonth() == arrDate.getMonth()){
						if(date.getDate() == arrDate.getDate())
						{
							return true;
						}else return false;
					}else return false;
				}else return false;
			}
			
			
			/**
			 * Change participants user 
			 */ 
			private function onChangeSessionUsers(event:SessionHomeElementEvent):void{
				var sessionView:SessionHomeElement = event.currentTarget as SessionHomeElement;
				var sessionId:uint = sessionView.session.getSessionId();
				var oldUserId:uint = event.oldSessionUser.getId();
				var newUserId:uint = event.newSessionUser.getId();
				
				var oldSessionUser:SessionUserVO = new SessionUserVO();
				oldSessionUser.id_session = sessionId;
				oldSessionUser.id_user = oldUserId;
				
				var newSessionUser:SessionUserVO = new SessionUserVO();
				newSessionUser.id_session = sessionId;
				newSessionUser.id_user = newUserId;
				
				var sessionUserEvent:SessionUserEvent = new SessionUserEvent(SessionUserEvent.UPDATE_SESSION_USER);
				sessionUserEvent.oldSessionUser = oldSessionUser;
				sessionUserEvent.newSessionUser = newSessionUser;
				dispatchEvent(sessionUserEvent);	
			}
			
			/**
			 * Check action of logged user  
			 */ 
			private function onClickActionLoggedUser(event:SessionHomeElementEvent):void
			{
				var eventSession:SessionEvent;
				switch(event.typeAction)
				{
					case SessionHomeElementEvent.ACTION_JOIN_SESSION:
					{
						eventSession = new SessionEvent(SessionEvent.JOIN_SESSION);
						break;
					}
					case SessionHomeElementEvent.ACTION_EDIT_SESSION:
					{
						eventSession = new SessionEvent(SessionEvent.EDIT_SESSION);
						break;
					}
					case SessionHomeElementEvent.ACTION_CANCEL_SESSION:
					{
						eventSession = new SessionEvent(SessionEvent.CANCEL_SESSION);
						break;
					}				
				}
				eventSession.session = event.session;
				dispatchEvent(eventSession);
			}
			
			/**
			 * Update dataProvider each sessionView
			 */ 
			public function updateView(event:SessionEvent = null):void
			{
				for each(var view:SessionHomeElement in this.listSessionView)
				{
					view.session.checkConnectedUsers(Model.getInstance().getConnectedUsers());
					view.updateViewUsers();
				}		
			}
			
			/**
			 * Show list connected users, exclude logged user
			 */ 
			protected function sendOneUser_clickHandler(event:MouseEvent):void
			{
				/* if(listConUsers.visible){
					listConUsers.visible = false;
				}else
				{
					var listConnectedUserExludeLoggedUser:ArrayCollection = Model.getInstance().getConnectedUserExcludeLoggedUser();
					if (listConnectedUserExludeLoggedUser.length > 0)
					{
						listConUsers.dataProvider = listConnectedUserExludeLoggedUser;
						listConUsers.visible = true;
					}
				} */
			}		
			
		
			/**
			 * Handler the navigateurDay component
			 */ 
			protected function navigateurDay_changeHandler(event:IndexChangeEvent):void
			{
				var selectedItem:Object = (event.target as NavigateurDay).selectedItem as Object;
				// set selected item to Model
				Model.getInstance().setSelectedItemNavigateurDayByLoggedUser(selectedItem);
				var listSessionDate:ArrayCollection = selectedItem.listSessionDate;			
				if(listSessionDate == null){
					// set list session from BD
					var sessionEventLoad:SessionEvent = new SessionEvent(SessionEvent.LOAD_LIST_SESSION);
					sessionEventLoad.userId = Model.getInstance().getLoggedUser().id_user;
					sessionEventLoad.sessionDate = selectedItem.labelDate;
					dispatchEvent(sessionEventLoad);				
				}else{
					// update dataProvider SessionView 
					var sessionEvent:SessionEvent = new SessionEvent(SessionEvent.UPDATE_LIST_SESSION);
					sessionEvent.sessionDate = selectedItem.labelDate;
					sessionEvent.listSession = listSessionDate;
					dispatchEvent(sessionEvent);	
				}
			}	
			
			/**
			 * 
			 */
			protected function showLabalNavigateurDay(item:Object):String
			{
				var date:Date = item.fullDate as Date;
				if(this.isDateToday(date))
				{
					return fxgt.gettext("<<-- AUJOURD'HUI ");
				}else
				{
                /* FIXME: use mx.formatters.DateFormatter ("EEEE D MMMM YYYY") */
					var dayString:String = date.getDate().toString();
					var yearString:String = date.getFullYear().toString();
					var monthString:String = "";
					var month:Number = date.getMonth();
					switch (month){
						case 0:
							monthString = fxgt.gettext("JANVIER");
							break;
						case 1:
							monthString = fxgt.gettext("FÉVRIER");
							break;
						case 2:
							monthString = fxgt.gettext("MARS");
							break;
						case 3:
							monthString = fxgt.gettext("AVRIL");
							break;
						case 4:
							monthString = fxgt.gettext("MAI");
							break;
						case 5:
							monthString = fxgt.gettext("JUIN");
							break;
						case 6:
							monthString = fxgt.gettext("JUILLET");
							break;
						case 7:
							monthString = fxgt.gettext("AOÛT");
							break;
						case 8:
							monthString = fxgt.gettext("SEPTEMBRE");
							break;
						case 9:
							monthString = fxgt.gettext("OCTOBRE");
							break;
						case 10:
							monthString = fxgt.gettext("NOVEMBRE");
							break;
						case 11:
							monthString = fxgt.gettext("DÉCEMBRE");
							break;
					}
					var dayWeek:Number = date.getDay();
					var dayWeekString:String="";
					switch (dayWeek){
						case 0:
							dayWeekString = fxgt.gettext("DIMANCHE");
							break;
						case 1:
							dayWeekString = fxgt.gettext("LUNDI");
							break;
						case 2:
							dayWeekString = fxgt.gettext("MARDI");
							break;
						case 3:
							dayWeekString = fxgt.gettext("MERCREDI");
							break;
						case 4:
							dayWeekString = fxgt.gettext("JEUDI");
							break;
						case 5:
							dayWeekString = fxgt.gettext("VENDREDI");
							break;
						case 6:
							dayWeekString = fxgt.gettext("SAMEDI");
							break;		
					}
					return 	dayWeekString + " " + dayString + " " + monthString+ " " + yearString ;		
				}
			}
			
			/**
			 * Update language of te selected item 
			 */
			protected function updateLanguageNavigateurDay(event:ApplicationMenuEvent):void
			{
				var selectedDate:Object = Model.getInstance().getSelectedItemNavigateurDayByLoggedUser();
				this.navigateurDay.selectedIndex = -1;		
				this.navigateurDay.selectedItem = selectedDate;				
			}
			
			/**
			 * Send message to all by click button "enter"
			 */
			protected function onKeyUp(event:KeyboardEvent):void
			{
				if (event.keyCode == Keyboard.ENTER)
				{
					sendAll_clickHandler();
				}
			}
			
			/**
			 * set list users of the plateforme 
			 */
			public function onLoadedAllUsers(event:SessionEvent):void
			{
				if(Model.getInstance().getCurrentHomeModule() as HomeModule == this)
				{
					logger.info("Initialize the user list");
					var listUsersPlateforme:ArrayCollection = new ArrayCollection()
					var listUser:Array = event.listDate;
					var nbrUser:int = listUser.length;
					logger.info("Total number of users: {0}", nbrUser);
					for(var nUser:int = 0; nUser < nbrUser; nUser++)
					{
						var userVO:UserVO = listUser[nUser];
						logger.debug("Initialize the user {0}", userVO.id_user);
						
						var user:User = new User(userVO);
						// add user 
						listUsersPlateforme.addItem(user);

						
						if(Model.getInstance().isUserConnected(user.id_user)) {
							logger.debug("The user {0} is already connected", userVO.id_user);
							user.setStatus(ConnectionStatus.CONNECTED);
						} else
							logger.debug("The user {0} is not connected", userVO.id_user);
					}
					// set list users the plateforme
					Model.getInstance().setListUsersPlateforme(listUsersPlateforme);
					
					// showAllUser(listUsersPlateforme);
					initializeUsers(listUsersPlateforme);
					
				}
			}
			
			
			// new version with the list
			public function initializeUsers(listUsersPlateforme:ArrayCollection):void
			{
				if(Model.getInstance().getCurrentHomeModule() as HomeModule == this)
				{
					for each(var u in listUsersPlateforme) {
						usersList.addItem(u);
					}
				}
			}
			
		
			
			private function setListenerOnListConnectedUser(value:Boolean):void
			{
				var listConnectedUser:ArrayCollection = Model.getInstance().getConnectedUsers();
				if(value)
				{
					listConnectedUser.addEventListener(CollectionEvent.COLLECTION_CHANGE, onChangeListConnectedUser);				
				}else
				{
					if(listConnectedUser.hasEventListener(CollectionEvent.COLLECTION_CHANGE))
					{
						listConnectedUser.removeEventListener(CollectionEvent.COLLECTION_CHANGE, onChangeListConnectedUser);
					}
				}
			}
			
			/**
			* join/walk out user on/out the plateforme
			*/ 
			private function onChangeListConnectedUser(event:CollectionEvent):void
			{
				var listConnectedUser:ArrayCollection = Model.getInstance().getConnectedUsers();
				usersList.removeAll();
				initializeUsers(listConnectedUser);
			}
			
			
            import mx.events.MenuEvent;
            import mx.controls.Alert;
            import mx.logging.Log;
            import mx.logging.ILogger;
		
			private static var logger:ILogger = Log.getLogger("modules.HomeModule");

        	private var filterConnected:Boolean;
        	private var filterNotConnected:Boolean
        	private var filterRecording:Boolean
        	private var filterPending:Boolean
         	private var keepTuteur:Boolean
        	private var keepEtudiant:Boolean
        	private var keepResponsable:Boolean
        	private var keepAdmin:Boolean
 
            private function refreshUserList():void {
            	
            	filterConnected = userMenu.dataProvider[0].menuitem.(@id =="filterConnected").@toggled == 'true';
            	filterNotConnected = userMenu.dataProvider[0].menuitem.(@id =="filterNotConnected").@toggled == 'true';
            	filterRecording = userMenu.dataProvider[0].menuitem.(@id =="filterRecording").@toggled == 'true';
            	filterPending = userMenu.dataProvider[0].menuitem.(@id =="filterPending").@toggled == 'true';
	         	keepTuteur = userMenu.dataProvider[0].menuitem.(@id =="filterRoleTuteur").@toggled == 'true';
            	keepEtudiant = userMenu.dataProvider[0].menuitem.(@id =="filterRoleEtudiant").@toggled == 'true';
            	keepResponsable = userMenu.dataProvider[0].menuitem.(@id =="filterRoleResponsable").@toggled == 'true';
            	keepAdmin = userMenu.dataProvider[0].menuitem.(@id =="filterRoleAdministrateur").@toggled == 'true';
  
				logger.debug("Refreshing the user list (filterConnected={0},filterNotConnected={1},filterRecording={2},filterPending={3},keepTuteur={4},keepEtudiant={5},keepResponsable={6},keepAdmin={7})",
	            	filterConnected,
	            	filterNotConnected,
	            	filterRecording,
	            	filterPending,
		         	keepTuteur,
	            	keepEtudiant,
	            	keepResponsable,
	            	keepAdmin
            	);
            	
           		var sort:Sort = new Sort(); 
 				sort.fields = [new SortField("firstname", false), new SortField("lastname", false)];
				if( userMenu.dataProvider[0].menuitem.(@id =="sortMenu").menuitem.(@id =="sortByStatus").@toggled == 'true') {
					logger.debug("Setting the sort function of the user list to {0}", "compareUserByStatus");
					sort.compareFunction = compareUserByStatus;
				} else if( userMenu.dataProvider[0].menuitem.(@id =="sortMenu").menuitem.(@id =="sortByRole").@toggled == 'true') {
					logger.debug("Setting the sort function of the user list to {0}", "compareUserByRole");
					sort.compareFunction = compareUserByRole;
				} else {
					logger.debug("No sort function will apply to the user list (lexocographical order)");
					sort.compareFunction = null;
				}
				
				usersList.sort = sort;
               	usersList.refresh();
            }
            
            private function menuHandler(evt:MenuEvent):void {
				if (evt.item.@data != "top") {
					logger.info("A menu item has been clicked on the user list: {0} ", evt.item.@label);
					refreshUserList();
                }
            }
            
            function compareUserByRole(a:Object, b:Object, fields:Array = null):int {
				logger.debug("Comparing roles of user {0} ({1}) and  user {2} ({3})", a.firstname, a.role, b.firstname, b.role);
            	return a.role < b.role ? -1 :
            			a.role > b.role ? 1 : 0;
            }
            
            function compareUserByStatus(a:Object, b:Object, fields:Array = null):int {
				logger.debug("Comparing status of user {0} ({1}) and  user {2} ({3})", a.firstname, a.getStatus(), b.firstname, b.getStatus());
            	return a.getStatus() == b.getStatus() ?  0 :
            				a.getStatus() > b.getStatus() ?  -1 : 1;
            	
            }
            
  
            public function keepUser(item:Object):Boolean {
            	var userItem:User = item as User;
            	
            	var keepStatus:Boolean = false;
            	if(userItem.getStatus() == ConnectionStatus.CONNECTED)
       				keepStatus = filterConnected;
           		
            	if(userItem.getStatus() == ConnectionStatus.DISCONNECTED) 
       				keepStatus = filterNotConnected;
            	
            	if(userItem.getStatus() == ConnectionStatus.RECORDING) 
       				keepStatus = filterRecording;

            	if(userItem.getStatus() == ConnectionStatus.PENDING) 
       				keepStatus = filterPending;

            	var keepRole:Boolean = false;
            	if(VisuUtils.isTuteur(userItem)) 
            		keepRole = keepTuteur;
            	
            	if(VisuUtils.isStudent(userItem)) 
            		keepRole = keepEtudiant;
            	
            	if(VisuUtils.isResponsable(userItem)) 
            		keepRole = keepResponsable;
            	
            	if(VisuUtils.isAdmin(userItem))
            		keepRole = keepAdmin;
            	
	            var keep:Boolean = keepStatus && keepRole;
				logger.debug("User {0} {1} (id={2}, role={3}) is {4} in the user list [keepStatus:{5},keepRole:{6}]",
								 userItem.lastname,
								 userItem.firstname,
								 userItem.id_user,
								 VisuUtils.getRoleLabel(userItem.role),
								 keep?"KEPT":"NOT KEPT",
								 keepStatus,
								 keepRole
								 );
	            
		      	return keep;
		   }
		]]>
	</fx:Script>
	

	
	<s:VGroup gap="5" horizontalAlign="center" horizontalCenter="0"
		top="0" bottom="0" left="0" right="0" maxWidth="1024">

		<s:HGroup width="100%" height="50" horizontalAlign="left"
			gap="30" verticalAlign="bottom">
			<mx:Image source="{Model.getInstance().getLoggedUser().avatar}"
				width="50" height="50" />
			<s:Label
				text="{Model.getInstance().getLoggedUser().lastname + ' '+ Model.getInstance().getLoggedUser().getFirstName()}"
				fontSize="20" />
		</s:HGroup>
		<s:HGroup width="100%" height="100%">
			<!--<s:Label text="{Model.getInstance().getLoggedUser().getFirstName()}" 
				fontSize="20"/> -->
			<!-- CALENDAIRE -->
			<s:Group width="40%" height="100%">
				<s:layout>
					<s:VerticalLayout gap="5" />
				</s:layout>
				<s:HGroup horizontalAlign="center" width="100%"
					verticalAlign="justify">
					<s:BorderContainer width="100%" height="35"
						backgroundColor="#cedbef">
						<s:HGroup width="100%" height="100%" verticalAlign="middle"
							horizontalCenter="0">
							<s:Label width="100%" fontSize="14" color="#000000"
								paddingLeft="160">
								<s:text>{fxgt.gettext("CALENDRIER")}</s:text>
							</s:Label>
						</s:HGroup>
					</s:BorderContainer>
				</s:HGroup>
				<controls:NavigateurDay id="navigateurDay"
					dataProvider="{this.listDateForNavigateurDay}" labelFunction="showLabalNavigateurDay"
					visible="true" change="navigateurDay_changeHandler(event)" width="100%" />
				<s:Group width="100%" height="100%">
					<s:BorderContainer width="100%" borderVisible="false"
						height="100%" y="0" />
					<s:Scroller top="1" bottom="1" id="scrollerSession"
						width="100%" x="1">
						<s:VGroup id="sessionGroup" width="100%" height="100%"
							gap="15" horizontalAlign="center" />
					</s:Scroller>
				</s:Group>
				<!--<s:HGroup id="sessionGroup" x="0"/> -->
			</s:Group>
			<!-- FLUX ACTIVITY -->
			<s:HGroup id="fluxGroup" width="30%" verticalAlign="top"
				x="{navigateurDay.x + navigateurDay.width+10}" visible="true"
				height="100%">
				<s:VGroup gap="5" width="100%" paddingBottom="0" height="100%">
					<s:HGroup horizontalAlign="center" width="100%" height="35">
						<s:BorderContainer width="100%" height="35"
							backgroundColor="#CCDCC8">
							<s:HGroup width="100%" height="100%" verticalAlign="middle">
								<s:Label width="100%" fontSize="14" color="#000000"
									paddingLeft="40">
									<s:text>{fxgt.gettext("FLUX D'ACTIVITES DE L'ACCUEIL")}
									</s:text>
								</s:Label>
							</s:HGroup>
						</s:BorderContainer>
					</s:HGroup>
					<s:HGroup verticalAlign="middle" width="100%"
						horizontalAlign="center">
						<!-- <mx:Image id="imageLoggedUser" width="40" height="40"/> -->
						<s:TextInput id="textToSend" width="100%"
							height="{navigateurDay.height}" keyUp="onKeyUp(event)" />
						<s:Button height="{navigateurDay.height}" width="63"
							click="sendAll_clickHandler()">
							<s:label>{fxgt.gettext("Tous")}</s:label>
						</s:Button>
						<s:Button height="{navigateurDay.height}" width="80"
							click="sendOneUser_clickHandler(event)">
							<s:label>{fxgt.gettext("Personnel")}</s:label>
						</s:Button>
					</s:HGroup>

					<s:List selectionColor="#ffffff" borderAlpha="0.0"
						dataProvider="{fluxActivity}" width="100%"
						itemRenderer="com.ithaca.visu.renderer.FluxActivityRenderer"
						height="100%"
						creationComplete="refreshUserList();">
						<s:layout>
							<s:VerticalLayout gap="5" horizontalAlign="center"
								paddingBottom="0" paddingTop="0" />
						</s:layout>
					</s:List>
				</s:VGroup>
			</s:HGroup>
			
			<s:Panel id="userPanel" width="300" height="400" title="Utilisateurs">
				<s:VGroup width="100%" height="100%">
			
					<mx:MenuBar id="userMenu" width="100%" labelField="@label"
						itemClick="menuHandler(event);">
						<fx:XMLList>
							<!-- 
								Must provide an "id" attribute for EACH menuitem, otherwise, the XML navigation in actionscript will throw an error
								http://help.adobe.com/en_US/ActionScript/3.0_ProgrammingAS3/WS5b3ccc516d4fbf351e63e3d118a9b90204-7e6b.html   
							-->
							<menuitem id="root" label="Affichage" data="top">
								<menuitem id="sortMenu" label="Tri" data="top">
									<menuitem label="Par statut" type="radio" id="sortByStatus"
										groupName="radioGroup" toggled="true" />
									<menuitem label="Par rôle" type="radio" id="sortByRole"
										groupName="radioGroup" />
									<menuitem label="Par ordre alphabétique" id="sortByLexicoOrder"
										type="radio" groupName="radioGroup" />
								</menuitem>
								<menuitem type="separator" id="separator"/>
								<menuitem label="Attendu" id="filterPending"
									type="check" toggled="true" />
								<menuitem label="En cours d'enregistrement" id="filterRecording"
									type="check" toggled="true" />
								<menuitem label="Connecté" id="filterConnected" type="check"
									toggled="true" />
								<menuitem label="Non connecté" id="filterNotConnected"
									type="check" toggled="false" />
								<menuitem type="separator" id="separator"/>
								<menuitem label="Étudiants" id="filterRoleEtudiant" type="check"
									toggled="true" />
								<menuitem label="Tuteurs" id="filterRoleTuteur" type="check"
									toggled="true" />
								<menuitem label="Responsables de formation" id="filterRoleResponsable"
									type="check" toggled="true" />
								<menuitem label="Administrateurs" id="filterRoleAdministrateur"
									type="check" toggled="true" />
							</menuitem>
						</fx:XMLList>
					</mx:MenuBar>
			
					<s:List id="userList" width="100%" height="100%"
						dataProvider="{usersList}"
						itemRenderer="com.ithaca.visu.view.user.renderer.UserRenderer"
						/>
   
				</s:VGroup>
			</s:Panel>
		</s:HGroup>
	</s:VGroup>
</modules:VisuModuleBase>
