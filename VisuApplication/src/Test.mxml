<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" creationComplete="application1_creationCompleteHandler(event)" xmlns:media="flash.media.*" xmlns:controls="com.ithaca.visu.view.session.controls.*">
	<mx:Script>
		<![CDATA[
            import com.ithaca.visu.model.ActivityElement;
            import com.ithaca.visu.model.ActivityElementType;
            import com.ithaca.visu.view.session.controls.DocumentEdit;
            
            import mx.events.FlexEvent;
        

		public var timer:Timer = null;
        // player youtube
        private var playerYoutube:DocumentEdit;
        // link to youtube
        private var LINK_YOUTUBE:String = "http://www.youtube.com/watch?v=-q3_c5QMrfk&feature=relmfu";
		
		public function initCamera(event: StatusEvent = null):void
		{
            if (timer)
                timer.stop();

			camera = Camera.getCamera();
			if (camera == null)
			{
				clabel.text = "Pas de caméra détectée. Cliquez sur le bouton Réglages ci-dessous pour essayer de choisir un autre modèle.";
			} 
            else
            {
                camera.setMode( vd.width, vd.height, camera.fps);
                vd.attachCamera( camera );
                if (camera.muted)
                {
                    clabel.text = "Caméra détectée ["+camera.name+"] mais vous n'avez pas autorisé l'application à l'utiliser.";
                }
                else
                {
                    clabel.text = "Caméra détectée["+camera.name+"] - Vous devez vous voir dans la fenêtre ci-dessous";
                }
            }
			
			micro = Microphone.getMicrophone();
			if (micro == null)
			{
				mlabel.text = "Pas de micro détecté."
			}
            else
			{
                /* 
                 * Check for authorization updates.
                 * Since camera-less computers are more common, we subscribe here 
                 * at the microphone level. Since access authorization is global,
                 * it will correctly update the webcam status also.
                 */
                micro.addEventListener(StatusEvent.STATUS, initCamera);

				micro.setLoopBack(true);
				micro.setUseEchoSuppression(true);
				micro.setSilenceLevel(0);
                if (micro.muted)
                {
    				mlabel.text = "Micro détecté [" + micro.name + "] mais vous n'avez pas autorisé l'application à l'utiliser.";
                }
                else
                {
                    if (! timer)
                    {
                        timer = new Timer(100);
                        timer.addEventListener(TimerEvent.TIMER, checkVolume );
                        timer.start();
                    }
                    else
                    {
                        timer.start();
                    }
    				mlabel.text = "Micro détecté [" + micro.name + "] - la jauge de son doit bouger";
    			}
            }
        }
		
		private function checkVolume(event: TimerEvent = null):void
		{
			miclevel.setProgress(micro.activityLevel, 100);
			if (micro.activityLevel < 70) 
                miclevel.setStyle("barColor","haloBlue");
            else if(micro.activityLevel > 70 && micro.activityLevel < 90 )
                miclevel.setStyle("barColor","#FF9900");
		    else
                miclevel.setStyle("barColor","#CC0000");
		}


            protected function application1_creationCompleteHandler(event:FlexEvent):void
            {
                // init camera
                initCamera();
                
                // init youtube player 
                var playerYoutube:DocumentEdit = new DocumentEdit();
                playerYoutube.setEditabled(false);
                var activityObjet:Object = new Object();
                activityObjet.data = "Test de flux de youtube.com";
                activityObjet.url_element = LINK_YOUTUBE;
                activityObjet.type_element =  ActivityElementType.VIDEO;
                var activity:ActivityElement = new ActivityElement(activityObjet)
                playerYoutube.activityElement = activity;
                vboxYoutube.addElement(playerYoutube);
                
                // top message youtube
                topMessageYoutube.text = "Vous bla bla Vous bla bl Vous bla bl Vous bla bl...";
                // bottmon message youtube
                bottomMessageYoutube.text = "Vous bla bl Vous bla bl Vous bla bl ";
            }

		]]>
	</mx:Script>

	<mx:VBox id="vbox" >
        <mx:HBox width="100%" height="100%">
            <mx:VBox width="100%" height="100%" horizontalAlign="center">
        		<mx:Text selectable="false" id="clabel" width="100%" textAlign="center"/>
            	<mx:VideoDisplay width="300" height="200" id="vd" />
        		<mx:Text  id="mlabel" width="100%" textAlign="center"/>
        		<mx:ProgressBar id="miclevel" mode="manual" label="" width="100%" trackHeight="10"  height="13"  />
            </mx:VBox>
            <mx:Spacer width="25"/>
            <mx:VBox width="50%" height="100%" horizontalAlign="center">
                <mx:Text width="100%" id="topMessageYoutube" textAlign="center"/>
                <mx:VBox width="50%" height="100%" id="vboxYoutube"/>
                <mx:Text width="100%" id="bottomMessageYoutube" textAlign="center"/>
            </mx:VBox>
                
        </mx:HBox>  
        <mx:Button label="Réglages" id="reglages" click="Security.showSettings( SecurityPanel.CAMERA )" />
        <mx:Button label="Accéder à Visu" id="visu" click="navigateToURL(new URLRequest('visuclient.html'), '_self')" />
    </mx:VBox>
	
	
	<media:Microphone id="micro" rate="22" />
	<media:Camera id="camera" />
	
</mx:Application>
